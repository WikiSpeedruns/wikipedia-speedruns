{% extends 'base.html' %}

{% block head %}
<style>
/* Tooltip */
.button-tooltip-container {
    display: flex;
    align-items: center;
    margin-top: 16px;
    min-height: 30px;

}

.prompt-header h3 { 
  display: inline;
}

#custom-tooltip {
    display: none;
    margin-left: 10px;
}

.active-dropdown {
    display: block !important;
}
</style>


<script type="module">
import { fetchJson } from "/static/js/modules/fetch.js";
import { serverData } from "/static/js/modules/serverData.js";
import { getArticleTitle, articleCheck } from "/static/js/modules/wikipediaAPI/util.js";
import { PromptGenerator } from "/static/js/modules/generator.js"
import { autocompleteInput } from "/static/js/modules/autocomplete.js"

const LOBBY_ID = serverData["lobby_id"];
const successMessage = "Added prompt to lobby!";

var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    components: {
        'prompt-generator': PromptGenerator,
        'ac-input': autocompleteInput
    },
    data: {
        startPrompt:"",
        endPrompt:"",
        addPromptMessage:"",

        prompts: [],

        link: "",

        lobbyInfo: {
            "name": null,
            "desc": null,
            "user": {
                "name": null,
                "owner": null
            }
        },

        editPrompts: false,
        selectedPrompts: new Set(),

        users: null,
        anon_users: null,

        messageType: null,
        messageTimer: null
    },


    created: async function() {
        this.getPrompts();
        this.getLobbyInfo();
    },

    mounted: function() {
        this.link = window.location.href;
    },

    methods: {

        copyInviteLink() {
            const link = `Join my Wikispeedruns lobby\n${window.location.href}\nPasscode: ${this.lobbyInfo.passcode}`
            document.getElementById("custom-tooltip").style.display = "inline";
            navigator.clipboard.writeText(link);
            setTimeout(function() {
                document.getElementById("custom-tooltip").style.display = "none";
            }, 1500);
        },

        selectPrompt(prompt_id) {
            if (this.selectedPrompts.has(prompt_id)) {
                this.selectedPrompts.delete(prompt_id);
            } else {
                this.selectedPrompts.add(prompt_id);
            }
        },

        selectAllPrompts() {
            for (const prompt of this.prompts) {
                if(!this.selectedPrompts.has(prompt.prompt_id)){
                    this.selectPrompt(prompt.prompt_id);
                }
            }
        },

        deselectAllPrompts() {
            for (const prompt of this.prompts) {
                if(this.selectedPrompts.has(prompt.prompt_id)){
                    this.selectPrompt(prompt.prompt_id);
                }
            }
        },

        clearSelectedPrompts() {
            this.selectedPrompts.clear();
        },

        async getLobbyInfo() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}`);
            this.lobbyInfo = await resp.json();

            if (this.lobbyInfo.user.owner) {
                await this.getLobbyUsers();
            }
        },

        async getPrompts() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`);
            this.prompts = await resp.json();

        },

        async generatePrompt(e) {
            const prompt = await getGeneratedPrompt(this.difficulty);
            this.startPrompt = prompt["start"];
            this.endPrompt = prompt["end"];
        },

        clearMessage() {
            this.messageType = null;
        },

        setMessage(messageType) {
            this.messageType = messageType;
            setTimeout(this.clearMessage, 5000);
        },

        async considerPrompt() {
            this.addPromptMessage = "";

            const start = await getArticleTitle(this.startPrompt);
            if (start === null) {
                this.addPromptMessage = `"${this.startPrompt}" is not a Wikipedia article`;
                return;
            }

            const end = await getArticleTitle(this.endPrompt);
            if (end === null) {
                this.addPromptMessage = `"${this.endPrompt}" is not a Wikipedia article`;
                return;
            }

            const checkRes = await articleCheck(end);
            if ('warning' in checkRes) {
                this.addPromptMessage = checkRes["warning"];
                return;
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "POST", {
                "start": start,
                "end": end
            });
            if(resp.status !== 200){
                this.addPromptMessage = "Error adding prompt to database"
                return;            
            }

            this.addPromptMessage = successMessage;
        },

        async addPrompt() {
            await this.considerPrompt();

            const messageType = this.addPromptMessage == successMessage ? 'success' : 'danger';
            this.setMessage(messageType);

            this.getPrompts();
        },

        async deletePrompts() {
            if (!confirm("Are you sure you want to delete the selected prompts and their runs?")) {
               return; 
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "DELETE", {
                "prompts": Array.from(this.selectedPrompts),
            }); 

            this.editPrompts = false;
            this.clearSelectedPrompts();
            this.getPrompts();
        },


        async getLobbyUsers() {

            Promise.all([
                fetchJson(`/api/lobbys/players/${LOBBY_ID}`, "GET"), 
                fetchJson(`/api/lobbys/anon_players/${LOBBY_ID}`, "GET")
            ])
            .then(responses =>
                Promise.all(responses.map(res => res.json()))
            ).then(resp => {
                this.users = resp[0];
                this.anon_users = resp[1];
            }).catch(err => console.log(err));

        },

        async makeHost(user_id, username) {
            if (!confirm(`Are you sure you want to make ${username} the lobby host?`)) {
                return; 
            }

            try {
                const resp = await fetchJson(`/api/lobbys/change_host/${LOBBY_ID}`, "PATCH", {
                    "target_user_id": user_id,
                });
                
                alert(`${username} is now host!`);
                window.location.reload();
            } catch (e) {
                console.log(e)
                alert(e);
            }
        },

        toggleDropdown(id) {
            document.getElementById(id).classList.toggle("active-dropdown")
        }
    }


})

</script>
{% endblock %}

{% block content %}
<div id="app" v-cloak>
    <h2 v-if="lobbyInfo.name">[[lobbyInfo.name]]</h2>
    <h2 v-else>Lobby [[lobbyInfo.lobby_id]]: </h2>

    <p>[[lobbyInfo.desc]]</p>

    <details>
        <summary>Click Here to Show Lobby Link/Passcode: </summary>
        <p> Link: [[link]]    </p>
        <p> Passcode: [[lobbyInfo.passcode]]    </p>
    </details>

    <div class="button-tooltip-container">
        <button @click="copyInviteLink" class="btn btn-light">Copy Invite</button>
        <span id="custom-tooltip" ref="shareTooltip">Copied invite to clipboard!</span>
    </div>

    

    <template v-if="lobbyInfo.user.owner">

        <hr>

        <h3>Lobby settings</h4>

        <details>
            <summary>List of players</summary>
            <div class="card">
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <th scope="col">Display name</th>
                            <th scope="col">User type</th>
                            <th scope="col"></th>
                        </thead>
                        <tbody>
                            <tr v-for="user in users" v-cloak>
                                <td>[[user.username]]</td>
                                <td>Registered User</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" 
                                                type="button" 
                                                data-toggle="dropdown" 
                                                aria-haspopup="true" 
                                                aria-expanded="true"
                                                @click="toggleDropdown(String(user.user_id)+'dropdown')">
                                            <small>Options</small>
                                        </button>
                                        <div class="dropdown-menu" 
                                            v-bind:id="String(user.user_id)+'dropdown'">
                                            <button v-if="!user.owner" class="btn btn-sm" @click="makeHost(user.user_id, user.username)">Transfer Ownership</button>
                                            <button class="btn btn-sm disabled" v-else>Currently host</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr v-for="user in anon_users" v-cloak>
                                <td>[[user.name]]</td>
                                <td>Anonymous User</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </details>

        <h4 class="py-4">Manage: Add a prompt</h4>

        <form id="newPrompt" v-on:submit.prevent="addPrompt">
            <div class="my-2 row">
                <div class="col-md-4 col-sm-6">
                    <!-- <input  class="form-control" type="text" id="start" name="start" placeholder="Start Article" v-model="startPrompt"> -->
                    <ac-input :text.sync="startPrompt" placeholder="Start Article"></ac-input>
                </div>
            </div>

            <div class="mb-2 row">
                <div class="col-md-4 col-sm-6">
                    <!-- <input class="form-control" type="text" id="end" name="end" placeholder="End Article" v-model="endPrompt"> -->
                    <ac-input :text.sync="endPrompt" placeholder="End Article"></ac-input>
                </div>
            </div>

            <details class="mb-4">
                <summary>Prompt Generation</summary>

                <prompt-generator
                    v-bind:start.sync="startPrompt"
                    v-bind:end.sync="endPrompt"
                ></prompt-generator>


            </details>

            <input class="btn btn-primary" type="submit" value="Submit">
        </form>

        <p v-if="messageType != null" :class="`text-${messageType}`">[[addPromptMessage]]</p>

        <hr>

    </template>


    <div class="prompt-header">
        <h3> Prompts </h3>
        <template v-if="lobbyInfo.user.owner">
            <a v-on:click="editPrompts = !editPrompts">(Edit)</a>
        </template>
    </div>
    
    <div class="card">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <th style="width:100px" scope="col">Prompt #</th>
                    <th scope="col">Start Article</th>
                    <th scope="col">End Article</th>
                    <th class="text-center"></th>
                </thead>
                <tbody>
                    <tr v-for="prompt in prompts" v-cloak>
                        <td>[[prompt.prompt_id]]
                            (<a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/play/' + prompt.prompt_id">play</a>)
                        </td>

                        <td>[[prompt.start]]</td>
                        <td>[[prompt.end]]</td>

                        <td><a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/leaderboard/' + prompt.prompt_id">Results</a></td>
                        <td v-if="editPrompts">
                            <input type="checkbox" @click="selectPrompt(prompt.prompt_id)">
                        </td>
                    </tr>
                </tbody>
            </table>
            <div v-if="editPrompts">
                <input href="javascript:;" @click="deletePrompts" class="btn btn-danger" value="Delete Selected">
                <input href="javascript:;" @click="selectAllPrompts" class="btn btn-primary" value="Select All">
                <input href="javascript:;" @click="deselectAllPrompts" class="btn btn-primary" value="Deselect All">
            </div>
        </div>
    </div>


</div>
{% endblock %}
