{% extends 'base.html' %}

{% block head %}
<script type="module">
import { fetchJson } from "/static/js/modules/fetch.js";
import { serverData } from "/static/js/modules/serverData.js";
import { getArticleTitle } from "/static/js/modules/wikipediaAPI/util.js";

const LOBBY_ID = serverData["lobby_id"];

var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    data: {
        startPrompt:"",
        endPrompt:"",
        addPromptMessage:"",

        prompts: [],

        lobbyInfo: {}
    },

    created: async function() {
        this.getPrompts();
    },

    methods: {
        async getPrompts() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`);
            this.prompts = await resp.json();

        },


        async addPrompt() {
            this.addPromptMessage = "";

            const start = await getArticleTitle(this.startPrompt);
            if (start === null) {
                this.addPromptMessage = `"${this.startPrompt}" is not a Wikipedia article`;
                return;
            }

            const end = await getArticleTitle(this.endPrompt);
            if (end === null) {
                this.addPromptMessage = `"${this.startPrompt}" is not a Wikipedia article`;
                return;
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "POST", {
                "start": start,
                "end": end
            });

            this.getPrompts();
        }
    }


})

</script>
{% endblock %}

{% block content %}
<div id="app">
    <h2>Lobby</h2>

    <hr>

    <table class="table table-hover">
        <thead>
            <th style="width:100px" scope="col">Prompt #</th>
            <th scope="col">Start Article</th>
            <th class="text-center"></th>
        </thead>
        <tbody>
            <tr v-for="prompt in prompts" v-cloak>
                <td>[[prompt.prompt_id]]</span>
                    <template v-if="loggedIn">
                        (<a v-bind:href="'/play/' + prompt.prompt_id">play</a>)
                    </template>
                    <template v-else>
                        (<a v-on:click="alertLogin" v-bind:href="'/play/' + prompt.prompt_id">play</a>)
                    </template>

                </td>

                <td>[[prompt.start]]</td>
                <td class="text-center">
                    <template v-if="prompt.played">
                        <a v-bind:href="'/prompt/' + prompt.prompt_id">Results</a>
                    </template>
                    <template v-else>
                        <span title="Play this prompt to see the results!">-</span>
                    </template>
                </td>
                </tr>
        </tbody>
    </table>


    <template>

        <hr>
        <h2>Manage Lobby</h2>
        <h4> Add a prompt</h4>
        <form id="newPrompt" v-on:submit.prevent="addPrompt">
            <label for="start">Start Article:</label>
            <input type="text" id="start" name="start" v-model="startPrompt">
            <label for="end">End Article:</label>
            <input type="text" id="end" name="end" v-model="endPrompt">

            <input type="submit" value="Submit">
        </form>

        <p>[[addPromptMessage]]</p>
    </template>


</div>
{% endblock %}
