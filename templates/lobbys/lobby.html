{% extends 'base.html' %}

{% block head %}
<style>
/* Tooltip */
.button-tooltip-container {
    display: flex;
    align-items: center;
    margin-top: 16px;
    min-height: 30px;

}

#custom-tooltip {
    display: none;
    margin-left: 10px;
}
</style>


<script type="module">
import { fetchJson } from "/static/js/modules/fetch.js";
import { serverData } from "/static/js/modules/serverData.js";
import { getArticleTitle } from "/static/js/modules/wikipediaAPI/util.js";
import { getGeneratedPrompt } from "/static/js/modules/generator.js"

const LOBBY_ID = serverData["lobby_id"];

var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    data: {
        startPrompt:"",
        endPrompt:"",
        addPromptMessage:"",

        prompts: [],

        lobbyInfo: {
            "name": null,
            "desc": null,
            "user": {
                "name": null,
                "owner": null
            }
        },

        logdifficulty: 3,
    },

    computed: {
        difficulty() {
            return Math.round(Math.pow(10, this.logdifficulty))
        },

        approx_difficulty() {
            // Returns difficulty with 2 sig figs to give a sense of how many prompts you are choosing rom
            const rounding = Math.pow(10, Math.floor(this.logdifficulty));
            return Math.round(this.difficulty / rounding) * rounding;
        }
    },



    created: async function() {
        this.getPrompts();
        this.getLobbyInfo();
    },

    methods: {

        copyInviteLink() {
            const link = `Join my Wikispeedruns lobby\n${window.location.href}\nPasscode: ${this.lobbyInfo.passcode}`
            document.getElementById("custom-tooltip").style.display = "inline";
            navigator.clipboard.writeText(link);
            setTimeout(function() {
                document.getElementById("custom-tooltip").style.display = "none";
            }, 1500);
        },

        async getLobbyInfo() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}`);
            this.lobbyInfo = await resp.json();
        },

        async getPrompts() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`);
            this.prompts = await resp.json();

        },

        async generatePrompt(e) {
            const prompt = await getGeneratedPrompt(this.difficulty);
            this.startPrompt = prompt["start"];
            this.endPrompt = prompt["end"];
        },


        async addPrompt() {
            this.addPromptMessage = "";

            const start = await getArticleTitle(this.startPrompt);
            if (start === null) {
                this.addPromptMessage = `"${this.startPrompt}" is not a Wikipedia article`;
                return;
            }

            const end = await getArticleTitle(this.endPrompt);
            if (end === null) {
                this.addPromptMessage = `"${this.endPrompt}" is not a Wikipedia article`;
                return;
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "POST", {
                "start": start,
                "end": end
            });

            this.getPrompts();
        }
    }


})

</script>
{% endblock %}

{% block content %}
<div id="app" v-cloak>
    <h2 v-if="lobbyInfo.name">[[lobbyInfo.name]]</h2>
    <h2 v-else>Lobby [[lobbyInfo.lobby_id]]: </h2>

    <p>[[lobbyInfo.desc]]</p>

    <h4>Invite Others: </h4>
    <!--<p> Link: [[window.location.href]]    </p>-->
    <p> Passcode: [[lobbyInfo.passcode]]    </p>


    <div class="button-tooltip-container">
        <button @click="copyInviteLink" class="btn btn-light">Copy Invite</button>
        <span id="custom-tooltip" ref="shareTooltip">Copied invite to clipboard!</span>
    </div>


    <template v-if="lobbyInfo.user.owner">
        <hr>

        <h4>Manage: Add a prompt</h4>

        <form id="newPrompt" v-on:submit.prevent="addPrompt">
            <div class="my-2 row">
                <div class="col-md-4 col-sm-6">
                    <input  class="form-control" type="text" id="start" name="start" placeholder="Start Article" v-model="startPrompt">
                </div>
            </div>

            <div class="mb-2 row">
                <div class="col-md-4 col-sm-6">
                    <input class="form-control" type="text" id="end" name="end" placeholder="End Article" v-model="endPrompt">
                </div>
            </div>

            <details class="mb-4">
                <summary>Prompt Generation</summary>

                <input id="difficulty" type="range" min="2" max="5" v-model="logdifficulty" class="slider" step="0.1">
                <label for="difficulty">Selecting from the [[approx_difficulty]] most reachable articles</label>

                <button class="btn btn-secondary" v-on:click.prevent="generatePrompt"> Generate </button>

            </details>

            <input class="btn btn-primary" type="submit" value="Submit">
        </form>

        <p>[[addPromptMessage]]</p>


        <hr>

    </template>


    <h3> Prompts </h3>

    <div class="card">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <th style="width:100px" scope="col">Prompt #</th>
                    <th scope="col">Start Article</th>
                    <th scope="col">End Article</th>
                    <th class="text-center"></th>
                </thead>
                <tbody>
                    <tr v-for="prompt in prompts" v-cloak>
                        <td>[[prompt.prompt_id]]
                            (<a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/play/' + prompt.prompt_id">play</a>)
                        </td>

                        <td>[[prompt.start]]</td>
                        <td>[[prompt.end]]</td>

                        <td><a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/prompt/' + prompt.prompt_id">Results</a></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


</div>
{% endblock %}
