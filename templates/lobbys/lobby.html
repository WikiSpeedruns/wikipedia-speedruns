{% extends 'base.html' %}

{% block head %}
<style>
/* Tooltip */
.button-tooltip-container {
    display: flex;
    align-items: center;
    margin-top: 16px;
    min-height: 30px;

}

.prompt-header h3 { 
  display: inline;
}

#custom-tooltip {
    display: none;
    margin-left: 10px;
}
</style>


<script type="module">
import { fetchJson } from "/static/js/modules/fetch.js";
import { serverData } from "/static/js/modules/serverData.js";
import { getArticleTitle, articleCheck } from "/static/js/modules/wikipediaAPI/util.js";
import { PromptGenerator } from "/static/js/modules/generator.js"

const LOBBY_ID = serverData["lobby_id"];

var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    components: {
        'prompt-generator': PromptGenerator
    },
    data: {
        startPrompt:"",
        endPrompt:"",
        addPromptMessage:"",

        prompts: [],

        link: "",

        lobbyInfo: {
            "name": null,
            "desc": null,
            "user": {
                "name": null,
                "owner": null
            }
        },

        editPrompts: false,
        selectedPrompts: new Set(),
    },


    created: async function() {
        this.getPrompts();
        this.getLobbyInfo();
    },

    mounted: function() {
        this.link = window.location.href;
    },

    methods: {

        copyInviteLink() {
            const link = `Join my Wikispeedruns lobby\n${window.location.href}\nPasscode: ${this.lobbyInfo.passcode}`
            document.getElementById("custom-tooltip").style.display = "inline";
            navigator.clipboard.writeText(link);
            setTimeout(function() {
                document.getElementById("custom-tooltip").style.display = "none";
            }, 1500);
        },

        selectPrompt(prompt_id) {
            if (this.selectedPrompts.has(prompt_id)) {
                this.selectedPrompts.delete(prompt_id);
            } else {
                this.selectedPrompts.add(prompt_id);
            }
        },

        clearSelectedPrompts() {
            this.selectedPrompts.clear();
        },

        async getLobbyInfo() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}`);
            this.lobbyInfo = await resp.json();
        },

        async getPrompts() {
            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`);
            this.prompts = await resp.json();

        },

        async generatePrompt(e) {
            const prompt = await getGeneratedPrompt(this.difficulty);
            this.startPrompt = prompt["start"];
            this.endPrompt = prompt["end"];
        },


        async addPrompt() {
            this.addPromptMessage = "";

            const start = await getArticleTitle(this.startPrompt);
            if (start === null) {
                this.addPromptMessage = `"${this.startPrompt}" is not a Wikipedia article`;
                return;
            }

            const end = await getArticleTitle(this.endPrompt);
            if (end === null) {
                this.addPromptMessage = `"${this.endPrompt}" is not a Wikipedia article`;
                return;
            }

            const checkRes = await articleCheck(this.endPrompt);
            if ('warning' in checkRes) {
                this.addPromptMessage = checkRes["warning"];
                return;
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "POST", {
                "start": start,
                "end": end
            });

            this.getPrompts();
        },

        async deletePrompts() {
            if (!confirm("Are you sure you want to delete the selected prompts and their runs?")) {
               return; 
            }

            const resp = await fetchJson(`/api/lobbys/${LOBBY_ID}/prompts`, "DELETE", {
                "prompts": Array.from(this.selectedPrompts),
            }); 

            this.editPrompts = false;
            this.clearSelectedPrompts();
            this.getPrompts();
        }
    }


})

</script>
{% endblock %}

{% block content %}
<div id="app" v-cloak>
    <h2 v-if="lobbyInfo.name">[[lobbyInfo.name]]</h2>
    <h2 v-else>Lobby [[lobbyInfo.lobby_id]]: </h2>

    <p>[[lobbyInfo.desc]]</p>

    <details>
        <summary>Click Here to Show Lobby Link/Passcode: </summary>
        <p> Link: [[link]]    </p>
        <p> Passcode: [[lobbyInfo.passcode]]    </p>
    </details>

    <div class="button-tooltip-container">
        <button @click="copyInviteLink" class="btn btn-light">Copy Invite</button>
        <span id="custom-tooltip" ref="shareTooltip">Copied invite to clipboard!</span>
    </div>


    <template v-if="lobbyInfo.user.owner">
        <hr>
        <h4>Manage: Add a prompt</h4>

        <form id="newPrompt" v-on:submit.prevent="addPrompt">
            <div class="my-2 row">
                <div class="col-md-4 col-sm-6">
                    <input  class="form-control" type="text" id="start" name="start" placeholder="Start Article" v-model="startPrompt">
                </div>
            </div>

            <div class="mb-2 row">
                <div class="col-md-4 col-sm-6">
                    <input class="form-control" type="text" id="end" name="end" placeholder="End Article" v-model="endPrompt">
                </div>
            </div>

            <details class="mb-4">
                <summary>Prompt Generation</summary>

                <prompt-generator
                    v-bind:start.sync="startPrompt"
                    v-bind:end.sync="endPrompt"
                ></prompt-generator>


            </details>

            <input class="btn btn-primary" type="submit" value="Submit">
        </form>

        <p class="text-danger">[[addPromptMessage]]</p>


        <hr>

    </template>


    <div class="prompt-header">
        <h3> Prompts </h3>
        <template v-if="lobbyInfo.user.owner">
            <a v-on:click="editPrompts = !editPrompts">(Edit)</a>
        </template>
    </div>
    
    <div class="card">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <th style="width:100px" scope="col">Prompt #</th>
                    <th scope="col">Start Article</th>
                    <th scope="col">End Article</th>
                    <th class="text-center"></th>
                </thead>
                <tbody>
                    <tr v-for="prompt in prompts" v-cloak>
                        <td>[[prompt.prompt_id]]
                            (<a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/play/' + prompt.prompt_id">play</a>)
                        </td>

                        <td>[[prompt.start]]</td>
                        <td>[[prompt.end]]</td>

                        <td><a v-bind:href="'/lobby/' + lobbyInfo.lobby_id + '/leaderboard/' + prompt.prompt_id">Results</a></td>
                        <td v-if="editPrompts">
                            <input type="checkbox" @click="selectPrompt(prompt.prompt_id)">
                        </td>
                    </tr>
                </tbody>
            </table>
            <input v-if="editPrompts" href="javascript:;" @click="deletePrompts" class="btn btn-danger" value="Delete Selected">
        </div>
    </div>


</div>
{% endblock %}
